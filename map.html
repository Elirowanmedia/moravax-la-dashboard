<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Moravax Louisiana Pilot — River Parishes (NO ⇄ BR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height:100%; margin:0; background:#0b0f12; }
    #map{ height:100%; }
    .panel-title{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:rgba(0,0,0,.78); color:#fff; padding:10px 12px; border-radius:10px;
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial; box-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    .legend{
      position:absolute; bottom:16px; left:12px; z-index:1000;
      background:rgba(0,0,0,.78); color:#ddd; padding:8px 10px; border-radius:8px;
      font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    .control-card{
      position:absolute; top:12px; right:12px; z-index:1000;
      background:rgba(0,0,0,.78); color:#fff; padding:10px 12px; border-radius:10px;
      width:270px; box-shadow:0 2px 10px rgba(0,0,0,.25);
      font:13px system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    .control-card h3{ margin:0 0 6px 0; font-size:14px; font-weight:700 }
    .control-card label{ display:block; margin:6px 0; cursor:pointer }
    .range{ width:100%; accent-color:#a64cff; }
    .tagbar{ margin-top:6px; display:flex; flex-wrap:wrap; gap:6px }
    .tag{
      background:#111; border:1px solid #333; color:#ddd; border-radius:999px;
      padding:4px 8px; font-size:12px; cursor:pointer;
    }
    .tag:hover{ background:#181818 }
    .note{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:8px; z-index:1000; color:#ddd; font:12px system-ui; opacity:.85;
    }
    .radiance-tiles { filter: brightness(1.8) contrast(1.35); }
    .blackmarble-tiles { filter: brightness(1.15) contrast(1.15); }
    .parish-label{
      color:#9ccfff; font:12px system-ui; text-shadow:0 0 6px rgba(0,0,0,.9);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Title -->
  <div class="panel-title">
    <b>Moravax Louisiana Pilot</b><br>
    <small>AOI: River Parishes — New Orleans ⇄ Baton Rouge</small>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div><b>Night-lights overlays</b></div>
    <div>• <b>VIIRS Radiance</b> — bright, for regional view (zoom ≤ 8)</div>
    <div>• <b>Black Marble</b> — subtle, for parish view (9–12)</div>
  </div>

  <!-- Controls -->
  <div class="control-card" id="controls">
    <h3>Layers</h3>
    <label><input type="radio" name="ol" value="viirs" checked> VIIRS DNB Radiance (bright)</label>
    <label><input type="radio" name="ol" value="bm"> Black Marble (subtle)</label>
    <label><input type="radio" name="ol" value="none"> None</label>

    <div style="margin-top:8px">Opacity</div>
    <input id="opacity" class="range" type="range" min="0.1" max="1" step="0.05" value="0.75">

    <div class="tagbar" style="margin-top:10px">
      <div class="tag" data-jump="aoi">AOI</div>
      <div class="tag" data-jump="denka">Denka</div>
      <div class="tag" data-jump="br">Baton Rouge</div>
      <div class="tag" data-jump="nola">New Orleans</div>
    </div>
  </div>

  <div class="note" id="zoomHint" style="display:none;">Night-lights render at regional zooms (≤ 8). Zoom out to see them.</div>

<script>
(function () {
  // ---------- CONFIG ---------------------------------------------------------
  const MAPBOX_TOKEN = 'pk.eyJ1IjoiZWxpcm93YW5tZWRpYSIsImEiOiJjbWV5d2Y5MWkwN2hzMnFwbG5idDhxa2E0In0.c09E3SqLY_s5bnQzo-M7qA';
  const VIIRS_DATE_RADIANCE = '2024-12-31'; // daily/near-real-time composite
  const BLACK_MARBLE_DATE   = '2024-01-01'; // annual product

  // Approx River Parishes rectangle AOI
  const AOI = [
    [30.60, -91.60],
    [30.60, -90.00],
    [29.50, -90.00],
    [29.50, -91.60]
  ];

  // Rough parish boxes (replace with real GeoJSON when available)
  const ROUGH_PARISHES_GEOJSON = {
    "type":"FeatureCollection",
    "features":[
      { "type":"Feature", "properties":{ "name":"St. John the Baptist (rough)" },
        "geometry":{"type":"Polygon","coordinates":[[[-90.65,30.18],[-90.25,30.18],[-90.25,29.92],[-90.65,29.92],[-90.65,30.18]]]}},
      { "type":"Feature", "properties":{ "name":"St. James (rough)" },
        "geometry":{"type":"Polygon","coordinates":[[[-91.10,30.12],[-90.70,30.12],[-90.70,29.85],[-91.10,29.85],[-91.10,30.12]]]}},
      { "type":"Feature", "properties":{ "name":"St. Charles (rough)" },
        "geometry":{"type":"Polygon","coordinates":[[[-90.50,30.10],[-90.17,30.10],[-90.17,29.75],[-90.50,29.75],[-90.50,30.10]]]}}
    ]
  };

  // Facilities (sample)
  const SITES = [
    {
      name: "Denka Performance Elastomer (LaPlace)",
      program: "CAA / Synthetic Rubber",
      coords: [30.068, -90.485],
      link: "https://echo.epa.gov/detailed-facility-report?fid=110000349321"
    },
    {
      name: "ExxonMobil Baton Rouge Refinery (cluster)",
      program: "CAA/CWA",
      coords: [30.457, -91.186],
      link: "https://echo.epa.gov/detailed-facility-report?fid=110000608532"
    },
    {
      name: "Shell / Norco (cluster)",
      program: "CAA/CWA",
      coords: [29.999, -90.418],
      link: "https://echo.epa.gov/detailed-facility-report?fid=110000463847"
    }
  ];

  // ---------- MAP INIT -------------------------------------------------------
  const map = L.map('map', { zoomControl: true, minZoom: 6, maxZoom: 18 });

  // Basemap: Mapbox Dark (raster tiles)
  const mapboxDark = L.tileLayer(
    `https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`,
    { tileSize: 512, zoomOffset: -1, attribution: '© Mapbox © OpenStreetMap' }
  ).addTo(map);

  // NASA overlays (WMTS)
  const viirsRadiance = L.tileLayer(
    `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_DayNightBand_At_Sensor_Radiance/default/${VIIRS_DATE_RADIANCE}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png`,
    { tileSize: 256, opacity: 0.75, className: 'radiance-tiles', crossOrigin: true,
      attribution: 'NASA VIIRS DNB Radiance' }
  );

  const blackMarble = L.tileLayer(
    `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_Black_Marble/default/${BLACK_MARBLE_DATE}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpg`,
    { tileSize: 256, opacity: 0.75, className: 'blackmarble-tiles', crossOrigin: true,
      attribution: 'NASA Black Marble' }
  );

  // AOI + rough parishes
  const aoiPoly = L.polygon(AOI, { color:'#9cf', weight:2, fill:false, dashArray:'6,4' }).addTo(map);

  const parishes = L.geoJSON(ROUGH_PARISHES_GEOJSON, {
    style: { color:'#8bd', weight:1.5, fill:false, dashArray:'4,6' },
    onEachFeature: (feat, layer) => {
      const c = layer.getBounds().getCenter();
      L.marker(c, {
        interactive:false,
        icon: L.divIcon({ className:'parish-label', html: feat.properties.name })
      }).addTo(map);
    }
  }).addTo(map);

  // Facilities
  const siteIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[0,-30], shadowSize:[41,41]
  });
  const sitesLayer = L.layerGroup(SITES.map(s => {
    const m = L.marker([s.coords[0], s.coords[1]], { icon: siteIcon });
    m.bindPopup(`<b>${s.name}</b><br>${s.program}<br><a href="${s.link}" target="_blank">EPA record ↗</a>`);
    return m;
  })).addTo(map);

  // Fit initial view to AOI at a “sweet spot” zoom ~9
  map.fitBounds(aoiPoly.getBounds(), { padding:[20,20] });
  if (map.getZoom() > 9) map.setZoom(9);

  // ---------------- UI: radio + opacity + bookmarks -------------------------
  const radios = Array.from(document.querySelectorAll('input[name="ol"]'));
  const opacity = document.getElementById('opacity');
  const zoomHint = document.getElementById('zoomHint');

  function setOverlayFromRadio() {
    const chosen = radios.find(r => r.checked)?.value;
    [viirsRadiance, blackMarble].forEach(l => l.remove());
    if (chosen === 'viirs') viirsRadiance.addTo(map);
    if (chosen === 'bm')    blackMarble.addTo(map);
  }
  radios.forEach(r => r.addEventListener('change', setOverlayFromRadio));
  opacity.addEventListener('input', () => {
    viirsRadiance.setOpacity(+opacity.value);
    blackMarble.setOpacity(+opacity.value);
  });

  // Bookmarks
  const jumps = {
    aoi:  aoiPoly.getBounds(),
    denka: L.latLngBounds([ [30.12,-90.60], [30.02,-90.40] ]),
    br:    L.latLngBounds([ [30.55,-91.30], [30.35,-91.05] ]),
    nola:  L.latLngBounds([ [30.08,-90.20], [29.85,-90.00] ])
  };
  document.querySelectorAll('.tag').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.getAttribute('data-jump');
      const b = jumps[key];
      if (b) map.fitBounds(b, { padding:[20,20] });
    });
  });

  // ---------------- Scale-aware overlay visibility --------------------------
  // VIIRS is useful at regional zooms; Black Marble at mid-zooms.
  function applyScaleRules() {
    const z = map.getZoom();
    const chosen = radios.find(r => r.checked)?.value;

    // Show hint if user chose VIIRS but zoomed in too far
    zoomHint.style.display = (chosen === 'viirs' && z > 8) ? 'block' : 'none';

    if (chosen === 'viirs') {
      if (z <= 8) { if (!map.hasLayer(viirsRadiance)) viirsRadiance.addTo(map); }
      else        { if (map.hasLayer(viirsRadiance)) viirsRadiance.remove(); }
    }
    if (chosen === 'bm') {
      if (z >= 9 && z <= 12) { if (!map.hasLayer(blackMarble)) blackMarble.addTo(map); }
      else                   { if (map.hasLayer(blackMarble)) blackMarble.remove(); }
    }
  }
  map.on('zoomend', applyScaleRules);
  setOverlayFromRadio();
  applyScaleRules();

  // ---------------- Quality-of-life -----------------------------------------
  // Click to drop temporary GPS marker (for quick field notes)
  map.on('click', (e) => {
    const s = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
    L.marker(e.latlng).addTo(map).bindPopup(`<b>GPS</b> ${s}`).openPopup();
  });

  // Ensure tiles lay out cleanly after first render
  setTimeout(() => map.invalidateSize(true), 60);
})();
</script>
</body>
</html>
