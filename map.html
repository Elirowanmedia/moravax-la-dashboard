<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Moravax Louisiana Pilot — River Parishes (NO ⇄ BR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height:100%; margin:0; background:#0c0f12; }
    #map{ height:100%; }

    /* Title pill */
    .panel-title{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:rgba(0,0,0,.80); color:#fff; padding:8px 10px; border-radius:10px;
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial; box-shadow:0 2px 10px rgba(0,0,0,.25);
    }

    /* Custom control containers */
    .moravax-ctrl{
      background:rgba(0,0,0,.80); color:#fff; padding:8px 10px; border-radius:10px;
      font:13px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial; box-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    .moravax-ctrl label{ display:block; margin:6px 0 0; }
    .moravax-ctrl input[type="range"]{ width:160px; }
    .hint{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:14px; z-index:1000; background:rgba(0,0,0,.85); color:#fff;
      padding:6px 10px; border-radius:10px; font:12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      box-shadow:0 2px 10px rgba(0,0,0,.25); display:none;
    }

    /* NASA tiles visual tuning */
    .radiance-tiles { filter: brightness(1.9) contrast(1.35); }
    .blackmarble-tiles { filter: brightness(1.15) contrast(1.15); }

    .bookmark-btn{
      display:inline-block; margin:4px 6px 0 0; padding:4px 8px; border-radius:8px;
      background:#1e1e1e; color:#fff; border:1px solid rgba(255,255,255,.12); cursor:pointer;
      font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    .bookmark-btn:hover{ background:#2a2a2a; }
    .copy-btn{
      margin-top:6px; background:#333; color:#fff; border:0; border-radius:6px; padding:4px 8px; cursor:pointer;
    }
    .copy-btn:hover{ background:#444; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel-title">
    <b>Moravax Louisiana Pilot</b><br>
    <small>AOI: River Parishes — New Orleans ⇄ Baton Rouge</small>
  </div>

  <div id="zoomHint" class="hint">Night-lights render at regional zooms (≤ 8). Zoom out to see them.</div>

<script>
(function () {
  // -------- CONFIG -----------------------------------------------------------
  const MAPBOX_TOKEN = 'pk.eyJ1IjoiZWxpcm93YW5tZWRpYSIsImEiOiJjbWV5d2Y5MWkwN2hzMnFwbG5idDhxa2E0In0.c09E3SqLY_s5bnQzo-M7qA';

  // NASA products/dates
  const VIIRS_DATE_RADIANCE = '2024-12-31'; // daily/near-real-time composite
  const BLACK_MARBLE_DATE   = '2024-01-01'; // annual composite

  // Approx River Parishes bbox polygon (NO ⇄ BR corridor)
  const AOI = [
    [30.60, -91.60],
    [30.60, -90.00],
    [29.50, -90.00],
    [29.50, -91.60]
  ];

  // Bookmarks
  const BOOKMARKS = [
    {label:'AOI',      action: (map, aoiBounds)=> map.fitBounds(aoiBounds, {padding:[20,20]})},
    {label:'Denka',    action: (map)=> map.setView([30.060, -90.560], 10)},
    {label:'Baton Rouge', action: (map)=> map.setView([30.450, -91.150], 10)},
    {label:'New Orleans', action: (map)=> map.setView([29.951, -90.072], 11)},
  ];

  // -------- MAP INIT ---------------------------------------------------------
  const map = L.map('map', { zoomControl: true, minZoom: 6, maxZoom: 18 });

  // Basemaps
  const mapboxDark = L.tileLayer(
    `https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`,
    { tileSize: 512, zoomOffset: -1, attribution: '© Mapbox © OpenStreetMap' }
  );

  const osm = L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom: 19, attribution: '© OpenStreetMap' }
  );

  // Safety fallback: if Mapbox errors, swap to OSM once
  let swapped = false;
  mapboxDark.on('tileerror', () => {
    if (!swapped) {
      swapped = true;
      map.removeLayer(mapboxDark);
      osm.addTo(map);
    }
  });
  mapboxDark.addTo(map);

  // NASA overlays (WMTS) — public, no keys
  const viirsRadiance = L.tileLayer(
    `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_DayNightBand_At_Sensor_Radiance/default/${VIIRS_DATE_RADIANCE}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png`,
    { tileSize: 256, opacity: 0.85, className: 'radiance-tiles', crossOrigin: true,
      attribution: 'NASA VIIRS DNB Radiance' }
  );

  const blackMarble = L.tileLayer(
    `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_Black_Marble/default/${BLACK_MARBLE_DATE}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpg`,
    { tileSize: 256, opacity: 0.80, className: 'blackmarble-tiles', crossOrigin: true,
      attribution: 'NASA Black Marble' }
  );

  // AOI boundary
  const aoiPoly = L.polygon(AOI, { color:'#9cf', weight:2, fill:false, dashArray:'6,4' });

  // -------- PERMALINK (hash) -----------------------------------------------
  function writeHash(extra={}) {
    const c = map.getCenter();
    const z = map.getZoom();
    const p = new URLSearchParams({
      z: z, lat: c.lat.toFixed(5), lng: c.lng.toFixed(5),
      ov: state.overlay, op: state.opacity.toFixed(2), ...extra
    });
    location.replace('#'+p.toString());
  }
  function readHash() {
    if (!location.hash) return null;
    const p = new URLSearchParams(location.hash.slice(1));
    const z = +p.get('z'), lat = +p.get('lat'), lng = +p.get('lng');
    const ov = p.get('ov'), op = +p.get('op');
    if (!Number.isFinite(z) || !Number.isFinite(lat) || !Number.isFinite(lng)) return null;
    return { z, lat, lng, ov, op };
  }

  // -------- OVERLAY STATE/HANDLERS ------------------------------------------
  const state = {
    overlay: 'radiance', // 'radiance' | 'black' | 'none'
    opacity: 0.85
  };
  const hintEl = document.getElementById('zoomHint');

  function showHint(show){ hintEl.style.display = show ? 'block' : 'none'; }

  function overlayLayerFor(key){
    if (key === 'radiance') return viirsRadiance;
    if (key === 'black') return blackMarble;
    return null;
  }

  function applyOverlay(){
    // Remove both, then add selected if allowed by zoom
    map.removeLayer(viirsRadiance);
    map.removeLayer(blackMarble);

    const layer = overlayLayerFor(state.overlay);
    if (!layer) { showHint(false); return; }

    // Opacity
    layer.setOpacity(state.opacity);

    // Zoom guard (GIBS night-lights stop at z<=8)
    if (map.getZoom() > 8){
      showHint(true);
      return;
    }
    showHint(false);
    layer.addTo(map);
  }

  // Update overlay on zoom changes
  map.on('zoomend', applyOverlay);

  // -------- UI: LAYERS & OPACITY CONTROL ------------------------------------
  // Standard layer switcher (basemaps + AOI)
  const overlays = { 'AOI Boundary': aoiPoly };
  L.control.layers({ 'Mapbox Dark': mapboxDark, 'OpenStreetMap': osm }, overlays, { collapsed: true }).addTo(map);

  // Custom overlay picker + opacity + bookmarks
  const OverlayControl = L.Control.extend({
    onAdd: function(){
      const div = L.DomUtil.create('div','moravax-ctrl');
      div.innerHTML = `
        <div style="font-weight:600;margin-bottom:4px;">Layers</div>
        <label><input type="radio" name="ov" value="radiance" checked> VIIRS DNB Radiance (bright)</label>
        <label><input type="radio" name="ov" value="black"> Black Marble (subtle)</label>
        <label><input type="radio" name="ov" value="none"> None</label>
        <label style="margin-top:8px;">Opacity <input id="opRange" type="range" min="0" max="1" step="0.01" value="0.85"></label>
        <div style="margin-top:8px;font-weight:600;">Bookmarks</div>
        <div id="bmRow"></div>
      `;
      // Prevent map drag on control interaction
      L.DomEvent.disableClickPropagation(div);

      // Wire radios
      div.querySelectorAll('input[name="ov"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          state.overlay = r.value;
          applyOverlay();
          writeHash();
        });
      });

      // Wire opacity
      const opRange = div.querySelector('#opRange');
      opRange.addEventListener('input', ()=>{
        state.opacity = +opRange.value;
        const layer = overlayLayerFor(state.overlay);
        if (layer) layer.setOpacity(state.opacity);
        writeHash();
      });

      // Bookmarks
      const bmRow = div.querySelector('#bmRow');
      BOOKMARKS.forEach(b=>{
        const btn = document.createElement('button');
        btn.className = 'bookmark-btn';
        btn.textContent = b.label;
        btn.addEventListener('click', ()=> b.action(map, aoiPoly.getBounds()));
        bmRow.appendChild(btn);
      });

      return div;
    },
    onRemove: function(){}
  });
  L.control.overlayControl = function(opts){ return new OverlayControl(opts); }
  L.control.overlayControl({ position:'topright' }).addTo(map);

  // -------- START VIEW -------------------------------------------------------
  // Add AOI and default overlay
  aoiPoly.addTo(map);

  // Hash → view/overlay/opacity
  const h = readHash();
  if (h){
    map.setView([h.lat, h.lng], h.z);
    if (h.ov==='black' || h.ov==='none') state.overlay = h.ov;
    if (Number.isFinite(h.op)) state.opacity = Math.min(1, Math.max(0, h.op));
    // Sync UI radios/slider
    const r = document.querySelector(`input[name="ov"][value="${state.overlay}"]`);
    if (r) r.checked = true;
    const opRange = document.getElementById('opRange');
    if (opRange) opRange.value = state.opacity.toFixed(2);
  } else {
    map.fitBounds(aoiPoly.getBounds(), { padding: [20,20] });
  }
  applyOverlay();
  // keep hash fresh
  map.on('moveend', ()=> writeHash());

  // -------- SCALE & CLICK-TO-COPY -------------------------------------------
  L.control.scale({ position:'bottomright', imperial:false }).addTo(map);

  map.on('click', (e) => {
    const txt = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
    const m = L.marker(e.latlng).addTo(map);
    m.bindPopup(`
      <div><b>GPS:</b> ${txt}<br>
        <button class="copy-btn" onclick="(async()=>{try{await navigator.clipboard.writeText('${txt}'); this.innerText='Copied!'; setTimeout(()=>this.innerText='Copy',1200);}catch(_){alert('Copy failed');}})()">Copy</button>
      </div>
    `).openPopup();
  });

  // -------- NUDGE LAYOUT -----------------------------------------------------
  setTimeout(()=> map.invalidateSize(true), 80);
})();
</script>
</body>
</html>
