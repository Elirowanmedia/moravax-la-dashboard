<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Moravax Louisiana Pilot — River Parishes (NO ⇄ BR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height:100%; margin:0 }
    #map{ height:100%; }
    .panel-title{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:rgba(0,0,0,.78); color:#fff; padding:8px 10px; border-radius:10px;
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial; box-shadow:0 2px 10px rgba(0,0,0,.25);
    }
    .radiance-tiles { filter: brightness(1.8) contrast(1.35); }
    .blackmarble-tiles { filter: brightness(1.15) contrast(1.15); }
    .copy-btn{
      margin-top:6px; background:#333; color:#fff; border:0; border-radius:6px; padding:4px 8px; cursor:pointer;
    }
    .copy-btn:hover{ background:#444; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel-title">
    <b>Moravax Louisiana Pilot</b><br>
    <small>AOI: River Parishes — New Orleans ⇄ Baton Rouge</small>
  </div>

<script>
(function () {
  // ---------- CONFIG ---------------------------------------------------------
  const MAPBOX_TOKEN = 'pk.eyJ1IjoiZWxpcm93YW5tZWRpYSIsImEiOiJjbWV5d2Y5MWkwN2hzMnFwbG5idDhxa2E0In0.c09E3SqLY_s5bnQzo-M7qA';
  const VIIRS_DATE_RADIANCE = '2024-12-31'; // daily/near-real-time composite
  const BLACK_MARBLE_DATE   = '2024-01-01'; // annual product
  // Approx River Parishes bbox polygon (NO ⇄ BR corridor)
  const AOI = [
    [30.60, -91.60],
    [30.60, -90.00],
    [29.50, -90.00],
    [29.50, -91.60]
  ];

  // ---------- MAP INIT -------------------------------------------------------
  const map = L.map('map', { zoomControl: true, minZoom: 6, maxZoom: 18 });

  // Parse simple #z/lat/lng hash
  function applyHash() {
    const h = location.hash.replace('#','').split('/');
    if (h.length === 3) {
      const z = +h[0], lat = +h[1], lng = +h[2];
      if (!Number.isNaN(z) && !Number.isNaN(lat) && !Number.isNaN(lng)) {
        map.setView([lat, lng], z);
        return true;
      }
    }
    return false;
  }
  // Update hash on move
  map.on('moveend', () => {
    const c = map.getCenter();
    const z = map.getZoom();
    location.replace(`#${z}/${c.lat.toFixed(5)}/${c.lng.toFixed(5)}`);
  });

  // Basemap: Mapbox Dark (raster tiles)
  const mapboxDark = L.tileLayer(
    `https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`,
    { tileSize: 512, zoomOffset: -1, attribution: '© Mapbox © OpenStreetMap' }
  );

  // Fallback: OSM
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom: 19, attribution: '© OpenStreetMap' });

  // If Mapbox errors, swap to OSM once
  let swapped = false;
  mapboxDark.on('tileerror', () => {
    if (!swapped) {
      swapped = true;
      map.removeLayer(mapboxDark);
      osm.addTo(map);
    }
  });
  mapboxDark.addTo(map);

  // NASA GIBS overlays (WMTS) — pure raster tiles, no keys needed
  const viirsRadiance = L.tileLayer(
    `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_DayNightBand_At_Sensor_Radiance/default/${VIIRS_DATE_RADIANCE}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png`,
    { tileSize: 256, opacity: 0.85, className: 'radiance-tiles', crossOrigin: true,
      attribution: 'NASA VIIRS DNB Radiance' }
  );

  const blackMarble = L.tileLayer(
    `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_Black_Marble/default/${BLACK_MARBLE_DATE}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpg`,
    { tileSize: 256, opacity: 0.80, className: 'blackmarble-tiles', crossOrigin: true,
      attribution: 'NASA Black Marble' }
  );

  // AOI boundary
  const aoiPoly = L.polygon(AOI, { color:'#9cf', weight:2, fill:false, dashArray:'6,4' });

  // Fit start view (or honor hash if present)
  if (!applyHash()) {
    map.fitBounds(aoiPoly.getBounds(), { padding: [20,20] });
  }

  // Add default overlay (Radiance)
  viirsRadiance.addTo(map);
  aoiPoly.addTo(map);

  // Layer control
  const overlays = {
    'VIIRS DNB Radiance (bright)': viirsRadiance,
    'Black Marble (subtle)': blackMarble,
    'AOI Boundary': aoiPoly
  };
  L.control.layers({ 'Mapbox Dark': mapboxDark, 'OpenStreetMap': osm }, overlays, { collapsed: false }).addTo(map);

  // Scale bar
  L.control.scale({ position:'bottomright', imperial:false }).addTo(map);

  // Drop GPS point on click with copy button
  map.on('click', (e) => {
    const txt = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
    const m = L.marker(e.latlng).addTo(map);
    m.bindPopup(`
      <div><b>GPS:</b> ${txt}<br>
        <button class="copy-btn" onclick="(async()=>{try{await navigator.clipboard.writeText('${txt}'); this.innerText='Copied!'; setTimeout(()=>this.innerText='Copy',1200);}catch(_){alert('Copy failed');}})()">Copy</button>
      </div>
    `).openPopup();
  });

  // Nudge layout once tiles begin to load (prevents rare blank canvas)
  setTimeout(() => map.invalidateSize(true), 60);
})();
</script>
</body>
</html>
